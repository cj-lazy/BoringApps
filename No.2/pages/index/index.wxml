<view class="container">
  
  <view class="navbar">
    <view class="nav-top-row">
      <view class="btn-pill black" bindtap="toggleMenu" wx:if="{{!isGuest}}">
        <text class="icon-swap">â‡„</text> åˆ‡æ¢ä¸»é¢˜
      </view>
      <view class="tag-guest" wx:else>ğŸ‘‹ è®¿å®¢æ¨¡å¼</view>

      <view class="btn-pill white" bindtap="toggleEdit" wx:if="{{!isGuest}}">
        <text class="icon-edit">âœ</text> {{isEditMode ? 'å®Œæˆ' : 'ç¼–è¾‘é€‰é¡¹'}}
      </view>
    </view>

    <view class="nav-bottom-row">
      <text class="app-title">{{currentTheme.name}}</text>
    </view>
  </view>

  <view class="stage" wx:if="{{!isEditMode && !showMenu}}">
    <view class="pop-card">
      <view class="card-header"><text class="icon-big">{{currentTheme.icon}}</text></view>
      <view class="card-body">
        <text class="result-text {{isRunning ? 'shaking-text' : ''}}">{{displayItem}}</text>
      </view>
      <view class="card-footer">
        <text class="status-dot {{isRunning ? 'green' : 'red'}}"></text>
        <text class="status-text">{{isRunning ? 'éšæœºä¸­...' : 'å‡†å¤‡å°±ç»ª'}}</text>
      </view>
    </view>

    <view class="stats-entry" bindtap="showStatsModal">
      <block wx:if="{{topPick}}">
        <text class="stats-label">ğŸ‘‘ æ¦œé¦–</text>
        <text class="stats-val">{{topPick.name}}</text>
        <text class="stats-count">({{topPick.count}}æ¬¡)</text>
        <text class="stats-arrow">ğŸ“Š</text>
      </block>
      <block wx:else>
        <text class="stats-label">ğŸ“œ æš‚æ— æˆ˜ç»©</text>
        <text class="stats-hint">ç‚¹å‡»æŸ¥çœ‹å†å² >></text>
      </block>
    </view>

    <view class="action-area">
      <button class="btn-main" bindtap="manualToggle" hover-class="btn-pressed">
        {{isRunning ? 'åœæ­¢ (STOP)' : 'å¼€å§‹ (START)'}}
      </button>

      <button class="btn-link" open-type="share" wx:if="{{!isGuest}}">
        é‚€è¯·å¥½å‹åšå†³å®š â”
      </button>
      
      <view wx:if="{{isGuest}}" style="margin-top:20rpx; width:100%">
        <button class="btn-secondary" bindtap="saveSharedTheme">ğŸ“¥ ä¿å­˜æ­¤ä¸»é¢˜</button>
      </view>
    </view>
  </view>

  <view class="sheet" wx:if="{{isEditMode && !showMenu}}">
    <view class="sheet-header">
      <text>ç®¡ç†é€‰é¡¹</text>
      <view class="sheet-close" bindtap="toggleEdit">Ã—</view>
    </view>
    <view class="input-zone">
      <input class="pop-input" placeholder="è¾“å…¥æ–°é€‰é¡¹..." value="{{inputValue}}" bindinput="onInput" confirm-type="done" bindconfirm="addItem"/>
      <view class="btn-add" bindtap="addItem">ï¼‹</view>
    </view>
    <scroll-view scroll-y class="list-zone">
      <view class="list-item" wx:for="{{currentTheme.items}}" wx:key="index">
        <text class="item-name">{{item.name}}</text>
        <view class="item-actions">
          <view class="weight-pill" catchtap="changeWeight" data-index="{{index}}">
            <text class="star-gold">â­</text>
            <text class="weight-num">{{item.weight ? item.weight : 1}}</text>
            <text class="weight-arrow">â–¼</text>
          </view>
          <view class="btn-del" bindtap="deleteItem" data-index="{{index}}">åˆ é™¤</view>
        </view>
      </view>
      <button class="btn-danger" bindtap="deleteTheme" wx:if="{{themes.length > 1}}">åˆ é™¤å½“å‰ä¸»é¢˜</button>
      <view style="height: 150rpx;"></view>
    </scroll-view>
  </view>

  <view class="mask {{showMenu ? 'visible' : ''}}" bindtap="toggleMenu">
    <view class="drawer {{showMenu ? 'open' : ''}}" catchtap="stopBubble">
      <view class="drawer-header">åˆ‡æ¢ä¸»é¢˜</view>
      <scroll-view scroll-y class="drawer-list">
        <view class="drawer-item {{currentThemeIndex === index ? 'active' : ''}}" wx:for="{{themes}}" wx:key="index" bindtap="switchTheme" data-index="{{index}}">
          <text class="d-icon">{{item.icon}}</text>
          <text class="d-name">{{item.name}}</text>
          <view class="d-arrow" wx:if="{{currentThemeIndex === index}}">â—</view>
        </view>
      </scroll-view>
      <view class="drawer-footer">
        <view class="divider-text">æ–°å»ºä¸»é¢˜</view>
        <view class="new-theme-row">
          <input class="pop-input small" placeholder="ä¸»é¢˜å" value="{{newThemeName}}" bindinput="onThemeInput"/>
          <input class="pop-input mini" placeholder="åŠ¨è¯" value="{{newThemeVerb}}" bindinput="onThemeVerbInput"/>
        </view>
        <button class="btn-create" bindtap="addNewTheme">æ·»åŠ å¹¶ä¿å­˜</button>
      </view>
    </view>
  </view>

  <view class="mask {{showStats ? 'visible' : ''}}" bindtap="closeStats">
    <view class="pop-modal" catchtap="stopBubble">
      <view class="modal-head">
        <text>å†å²ç»Ÿè®¡</text>
        <view bindtap="closeStats" style="font-size:40rpx">Ã—</view>
      </view>
      <view class="hero-block" wx:if="{{topPick}}">
        <text class="crown">ğŸ‘‘</text>
        <text class="hero-title">{{topPick.name}}</text>
        <text class="hero-desc">å…± {{currentVerb}} äº† {{topPick.count}} æ¬¡</text>
      </view>
      <scroll-view scroll-y class="stat-list">
        <view class="stat-row" wx:for="{{statsData}}" wx:key="name">
          <text class="s-name">{{item.name}}</text>
          <view class="progress-box">
            <view class="progress-bar" style="width: {{item.percent}}%"></view>
          </view>
          <text class="s-num">{{item.count}}</text>
        </view>
      </scroll-view>
      <button class="btn-clear" bindtap="clearHistory" wx:if="{{topPick}}">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰è®°å½•</button>
    </view>
  </view>
</view>